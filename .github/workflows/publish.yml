name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to build (e.g., v0.1.0)"
        required: true

jobs:
  release:
    name: Release macOS
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.8"

      - name: Install root dependencies
        run: bun install --frozen-lockfile

      - name: Get Version and Commit
        id: vars
        run: |
          TAG=${{ github.event.inputs.tag || github.ref_name }}
          VERSION=${TAG#v}
          COMMIT_HASH=$(git rev-parse --short HEAD)
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "commit_hash=${COMMIT_HASH}" >> $GITHUB_OUTPUT
        shell: bash

      - name: Get Previous Tag
        id: prev_tag
        run: |
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^^ 2>/dev/null || echo "")
          if [ -z "$PREVIOUS_TAG" ]; then
            PREVIOUS_TAG=$(git rev-list --max-parents=0 HEAD)
          fi
          echo "previous_tag=${PREVIOUS_TAG}" >> $GITHUB_OUTPUT
        shell: bash

      - name: Get Existing Release URL
        id: get_release
        uses: actions/github-script@v7
        with:
          script: |
            try {
              const release = await github.rest.repos.getReleaseByTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag: '${{ steps.vars.outputs.tag }}'
              });
              core.setOutput('upload_url', release.data.upload_url);
              return true;
            } catch (error) {
              if (error.status === 404) {
                core.setOutput('upload_url', '');
                return false;
              }
              core.setFailed(`Error getting release by tag: ${error.message}`);
              return false;
            }
          result-encoding: string
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub Release
        if: steps.get_release.outputs.result == 'false'
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.vars.outputs.tag }}
          release_name: Release ${{ steps.vars.outputs.tag }}
          body: |
            **Full Changelog**: https://github.com/${{ github.repository }}/compare/${{ steps.prev_tag.outputs.previous_tag }}...${{ steps.vars.outputs.tag }}

            **Commit SHA:** ${{ steps.vars.outputs.commit_hash }}
          draft: false
          prerelease: false

      - name: Build Electrobun app for macOS
        run: |
          echo "Building version ${{ steps.vars.outputs.version }} (${{ steps.vars.outputs.commit_hash }})"
          bun run build:mac

      - name: Package macOS Artifact
        id: package
        run: |
          APP_PATH=$(find . -type d -name "TiDB Desktop.app" | head -n 1)
          if [ -z "$APP_PATH" ]; then
            echo "Could not find TiDB Desktop.app"
            find . -type d -name "*.app"
            exit 1
          fi

          APP_DIR=$(dirname "$APP_PATH")
          APP_NAME=$(basename "$APP_PATH")

          cd "$APP_DIR"
          zip -r "TiDB Desktop.app.zip" "$APP_NAME"

          echo "asset_path=${APP_DIR}/TiDB Desktop.app.zip" >> $GITHUB_OUTPUT
        shell: bash

      - name: Upload macOS Artifact to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url || steps.get_release.outputs.upload_url }}
          asset_path: ${{ steps.package.outputs.asset_path }}
          asset_name: TiDB-Desktop-${{ steps.vars.outputs.tag }}-macos.app.zip
          asset_content_type: application/zip
